name: 部署到服务器

on:
    push:
        branches: ['main']

jobs:
    deploy:
        runs-on: ubuntu-latest

        steps:
            - name: 检出仓库代码
              uses: actions/checkout@v4

            - name: 调试-列出仓库文件
              run: ls -la $GITHUB_WORKSPACE

            - name: 设置SSH环境
              run: |
                  mkdir -p ~/.ssh
                  chmod 700 ~/.ssh
                  echo "${{ secrets.SSH_PRIVATE_KEY }}" | tr -d '\r' > ~/.ssh/github_actions_key
                  chmod 600 ~/.ssh/github_actions_key
                  ssh-keyscan -p ${{ secrets.SSH_PORT }} ${{ secrets.SERVER_IP }} >> ~/.ssh/known_hosts

            - name: 安装Rsync工具
              run: sudo apt-get update && sudo apt-get install -y rsync

            - name: 同步文件到服务器
              run: |
                  rsync -avz --progress \
                    --exclude='.git' \
                    --exclude='.github/' \
                    --exclude='node_modules/' \
                    --exclude='*.log' \
                    -e "ssh -i ~/.ssh/github_actions_key -o StrictHostKeyChecking=no -p ${{ secrets.SSH_PORT }}" \
                    $GITHUB_WORKSPACE/ \
                    ${{ secrets.SSH_USERNAME }}@${{ secrets.SERVER_IP }}:/www/wwwroot/egg-blog/ \
                    || echo "忽略非关键错误"

            - name: 重启PM2服务
              run: |
                  ssh -i ~/.ssh/github_actions_key -p ${{ secrets.SSH_PORT }} ${{ secrets.SSH_USERNAME }}@${{ secrets.SERVER_IP }} <<EOF
                  # 获取项目路径
                  PM2_PATH="/www/wwwroot/egg-blog"

                  # 检查PM2进程
                  if pm2 list | grep -q "egg-blog"; then
                    echo "正在重启现有应用..."
                    pm2 restart egg-blog --update-env
                  else
                    echo "启动新应用..."
                    cd $PM2_PATH && pm2 start ecosystem.config.js
                  fi

                  # 保存PM2配置
                  pm2 save
                  pm2 logs --lines 10
                  EOF

            - name: 强制成功步骤
              if: always()
              run: echo "强制继续执行流程..."

            - name: 调试-列出目标目录文件
              run: |
                  ssh -i ~/.ssh/github_actions_key -p ${{ secrets.SSH_PORT }} ${{ secrets.SSH_USERNAME }}@${{ secrets.SERVER_IP }} \
                    "ls -la /www/wwwroot/egg-blog"
