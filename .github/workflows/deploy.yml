name: 部署到服务器

on:
    push:
        branches: ['main']

jobs:
    deploy:
        runs-on: ubuntu-latest

        steps:
            - name: 检出仓库代码
              uses: actions/checkout@v4

            - name: 调试路径验证
              run: |
                  echo "当前工作目录: $GITHUB_WORKSPACE"
                  ls -la $GITHUB_WORKSPACE

            - name: 设置 SSH 环境
              run: |
                  mkdir -p ~/.ssh
                  chmod 700 ~/.ssh
                  echo "${{ secrets.SSH_PRIVATE_KEY }}" | tr -d '\r' > ~/.ssh/github_actions_key
                  chmod 600 ~/.ssh/github_actions_key
                  ssh-keyscan -p ${{ secrets.SSH_PORT }} ${{ secrets.SERVER_IP }} >> ~/.ssh/known_hosts

            - name: 确保目标目录存在
              run: |
                  ssh -i ~/.ssh/github_actions_key -p ${{ secrets.SSH_PORT }} ${{ secrets.SSH_USERNAME }}@${{ secrets.SERVER_IP }} \
                    "mkdir -p /www/wwwroot/egg-blog"

            - name: 智能同步文件（修复路径）
              run: |
                  # 关键修复：显式指定源目录为项目根目录
                  rsync -avz --progress \
                    --delete \
                    --exclude='node_modules/' \
                    --exclude='*.log' \
                    --filter='- empty/' \
                    -e "ssh -i ~/.ssh/github_actions_key -o StrictHostKeyChecking=no -p ${{ secrets.SSH_PORT }}" \
                    "$GITHUB_WORKSPACE/" \          # 使用仓库根目录
                    "${{ secrets.SSH_USERNAME }}@${{ secrets.SERVER_IP }}:/www/wwwroot/egg-blog/" \
                    || echo "忽略非关键错误"

            - name: 重启 PM2 服务
              run: |
                  ssh -i ~/.ssh/github_actions_key -p ${{ secrets.SSH_PORT }} ${{ secrets.SSH_USERNAME }}@${{ secrets.SERVER_IP }} \
                    "cd /www/wwwroot/egg-blog || exit 1
                     pm2 start npm --name 'app' -- start
                     pm2 save"
