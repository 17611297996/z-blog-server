name: 部署到服务器

on:
  push:
    branches: ['main']

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: 检出代码
        uses: actions/checkout@v4

      - name: 调试-列出仓库文件
        run: ls -la $GITHUB_WORKSPACE

      - name: 设置SSH环境
        run: |
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" | tr -d '\r' > ~/.ssh/github_actions_key
          chmod 600 ~/.ssh/github_actions_key
          ssh-keyscan -p ${{ secrets.SSH_PORT }} ${{ secrets.SERVER_IP }} >> ~/.ssh/known_hosts

      - name: 安装Rsync
        run: sudo apt-get update && sudo apt-get install -y rsync

      - name: 同步文件到服务器（增强排除规则）
        run: |
          rsync -avz --progress --delete \
            --exclude='node_modules' \        # 排除依赖目录
            --exclude='.git' \                # 排除 Git 元数据
            --exclude='.env' \                # 排除环境变量文件
            --exclude='.env.local' \          # 排除本地环境变量
            --exclude='.vscode' \             # 排除 VSCode 配置
            --exclude='.idea' \               # 排除 JetBrains 配置
            --exclude='.DS_Store' \           # 排除 macOS 系统文件
            --exclude='*.log' \               # 排除日志文件
            --exclude='*.sock' \              # 排除套接字文件
            --exclude='*.device' \            # 排除设备文件
            --exclude='*.fifo' \              # 排除命名管道
            --copy-links \                    # 复制符号链接内容
            -e "ssh -i ~/.ssh/github_actions_key -o StrictHostKeyChecking=no -p ${{ secrets.SSH_PORT }}" \
            $GITHUB_WORKSPACE/ \              # 源路径（带斜杠）
            ${{ secrets.SSH_USERNAME }}@${{ secrets.SERVER_IP }}:/www/wwwroot/egg-blog/  # 目标路径（带斜杠）

      - name: 修复服务器权限
        run: |
          ssh -i ~/.ssh/github_actions_key -p ${{ secrets.SSH_PORT }} ${{ secrets.SSH_USERNAME }}@${{ secrets.SERVER_IP }} \
            "chmod -R 755 /www/wwwroot/egg-blog/ && \
             chown -R www-data:www-data /www/wwwroot/egg-blog/"

      - name: 调试-列出目标目录文件
        run: |
          ssh -i ~/.ssh/github_actions_key -p ${{ secrets.SSH_PORT }} ${{ secrets.SSH_USERNAME }}@${{ secrets.SERVER_IP }} \
            "ls -la /www/wwwroot/egg-blog"
