name: 部署到服务器

on:
    push:
        branches: ['main']

jobs:
    deploy:
        runs-on: ubuntu-latest
        timeout-minutes: 20

        steps:
            - name: 检出代码
              uses: actions/checkout@v4

            - name: 设置 SSH 环境
              run: |
                  mkdir -p ~/.ssh
                  chmod 700 ~/.ssh
                  echo "${{ secrets.SSH_PRIVATE_KEY }}" | tr -d '\r' > ~/.ssh/github_actions_key
                  chmod 600 ~/.ssh/github_actions_key
                  ssh-keyscan -p ${{ secrets.SSH_PORT }} ${{ secrets.SERVER_IP }} >> ~/.ssh/known_hosts

            - name: 暴力终止旧进程（保留 node_modules）
              run: |
                  ssh -i ~/.ssh/github_actions_key -p ${{ secrets.SSH_PORT }} ${{ secrets.SSH_USERNAME }}@${{ secrets.SERVER_IP }} \
                  "pkill -9 -f 'node --no-deprecation' && \
                   pkill -9 pm2"

            - name: 配置目录权限（保留 node_modules）
              run: |
                  ssh -i ~/.ssh/github_actions_key -p ${{ secrets.SSH_PORT }} ${{ secrets.SSH_USERNAME }}@${{ secrets.SERVER_IP }} \
                  "sudo chown -R ${{ secrets.SSH_USERNAME }} /www/wwwroot/egg-blog && \
                   chmod -R 755 /www/wwwroot/egg-blog/node_modules"

            - name: 安全清理（绝对保留 node_modules）
              run: |
                  ssh -i ~/.ssh/github_actions_key -p ${{ secrets.SSH_PORT }} ${{ secrets.SSH_USERNAME }}@${{ secrets.SERVER_IP }} \
                  "rsync -av --delete -e 'ssh -i ~/.ssh/github_actions_key -p ${{ secrets.SSH_PORT }}' \
                  --exclude='node_modules/' \
                  --exclude='*.log' \
                  /empty/ ${{ secrets.SSH_USERNAME }}@${{ secrets.SERVER_IP }}:/www/wwwroot/egg-blog/"

            - name: 增量同步代码（不覆盖 node_modules）
              run: |
                  rsync -avz --progress \
                    --bwlimit=500 \
                    --delete \
                    --exclude='node_modules/' \
                    --exclude='*.log' \
                    -e "ssh -i ~/.ssh/github_actions_key -o StrictHostKeyChecking=no -p ${{ secrets.SSH_PORT }}" \
                    $GITHUB_WORKSPACE/ \
                    ${{ secrets.SSH_USERNAME }}@${{ secrets.SERVER_IP }}:/www/wwwroot/egg-blog/

            - name: 优化启动服务（禁用 PM2 守护进程）
              run: |
                  ssh -i ~/.ssh/github_actions_key -p ${{ secrets.SSH_PORT }} ${{ secrets.SSH_USERNAME }}@${{ secrets.SERVER_IP }} \
                  "cd /www/wwwroot/egg-blog && \
                  pm2 start npm --name 'app' -- start --no-daemon && \
                  pm2 save"
